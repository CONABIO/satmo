

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>satmo.processors &mdash; satmo 0.2.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="satmo 0.2.2 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> satmo
          

          
          </a>

          
            
            
              <div class="version">
                0.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command Line Users Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">satmo package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodoc.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autodoc.html#building-the-doc">Building the doc</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">satmo</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>satmo.processors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for satmo.processors</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>

<span class="kn">import</span> <span class="nn">netCDF4</span> <span class="k">as</span> <span class="nn">nc</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.crs</span> <span class="k">import</span> <span class="n">CRS</span>
<span class="kn">from</span> <span class="nn">pyproj</span> <span class="k">import</span> <span class="n">Proj</span>
<span class="kn">from</span> <span class="nn">affine</span> <span class="k">import</span> <span class="n">Affine</span>

<span class="kn">from</span> <span class="nn">.geo</span> <span class="k">import</span> <span class="n">geo_dict_from_nc</span><span class="p">,</span> <span class="n">get_raster_meta</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">filename_parser</span><span class="p">,</span> <span class="n">file_finder</span><span class="p">,</span> <span class="n">is_day</span><span class="p">,</span>
                    <span class="n">filename_builder</span><span class="p">,</span> <span class="n">to_km</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.visualization</span> <span class="k">import</span> <span class="n">make_preview</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="k">import</span> <span class="n">SeadasError</span>
<span class="kn">from</span> <span class="nn">.global_variables</span> <span class="k">import</span> <span class="p">(</span><span class="n">L3_SUITE_FROM_VAR</span><span class="p">,</span> <span class="n">QUAL_ARRAY_NAME_FROM_SUITE</span><span class="p">,</span>
                               <span class="n">STANDARD_L3_SUITES</span><span class="p">,</span> <span class="n">FLAGS</span><span class="p">)</span>

<div class="viewcode-block" id="nc2tif"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.nc2tif">[docs]</a><span class="k">def</span> <span class="nf">nc2tif</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proj4string</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate geotiff from L3m netcdf array</span>

<span class="sd">    Reads an existing array from a netcdf file and writes it</span>
<span class="sd">    with georeference as tiff</span>

<span class="sd">    Args:</span>
<span class="sd">        file (str): Path to the netcdf file containing the desired array</span>
<span class="sd">        proj4string (str): Coordinate reference system (optional, see geo_dict_from_nc)</span>

<span class="sd">    Returns:</span>
<span class="sd">        The function is used for its side effect of writing a geotiff on</span>
<span class="sd">        disk.</span>
<span class="sd">        The function also returns the file name of the produced file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate output file name</span>
    <span class="c1"># l3m nc products should only contain one variable, so that simply changing extension should suffice</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">file_out</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span>
    <span class="c1"># Get geo dict</span>
    <span class="n">geo_dict</span> <span class="o">=</span> <span class="n">geo_dict_from_nc</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">proj4string</span><span class="p">)</span>
    <span class="c1"># Retrieve var name from file name</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">filename_parser</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
    <span class="c1"># Read array</span>
    <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">nodata</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">_FillValue</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][:]</span>
    <span class="c1"># Update geo_dict</span>
    <span class="c1"># TODO: Check if dtype and nodata are constant across products, otherwise retrieve from nc metadata</span>
    <span class="n">geo_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">driver</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nodata</span> <span class="o">=</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="s1">&#39;lzw&#39;</span><span class="p">)</span>
    <span class="c1"># Write file</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">geo_dict</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write_band</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
    <span class="c1"># Return output filename</span>
    <span class="k">return</span> <span class="n">file_out</span></div>


<div class="viewcode-block" id="Composer"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.Composer">[docs]</a><span class="k">class</span> <span class="nc">Composer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compose arrays with min, max, median, max</span>
<span class="sd">    For inheritance only, not exported to package __init__&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate Composer class</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: numpy arrays (typically 2D) of similar shape</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_list</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composed_array</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositing_function</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="Composer.mean"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.Composer.mean">[docs]</a>    <span class="k">def</span> <span class="nf">mean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_list</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositing_function</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span></div>
<div class="viewcode-block" id="Composer.median"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.Composer.median">[docs]</a>    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_list</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositing_function</span> <span class="o">=</span> <span class="s1">&#39;median&#39;</span></div>
<div class="viewcode-block" id="Composer.max"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.Composer.max">[docs]</a>    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_list</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositing_function</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span></div>
<div class="viewcode-block" id="Composer.min"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.Composer.min">[docs]</a>    <span class="k">def</span> <span class="nf">min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composed_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_list</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositing_function</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span></div></div>

<span class="c1"># Compose time </span>

<div class="viewcode-block" id="FileComposer"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.FileComposer">[docs]</a><span class="k">class</span> <span class="nc">FileComposer</span><span class="p">(</span><span class="n">Composer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to compose multiple raster files into one (with methods inherited</span>
<span class="sd">    from the Composer class), and write the output to a file</span>


<span class="sd">    Typically designed to produce composites from L3m files.</span>
<span class="sd">    Can be used with single band geoTiff or single band netcdf files</span>

<span class="sd">    Example usage:</span>
<span class="sd">        &gt;&gt;&gt; import satmo</span>
<span class="sd">        &gt;&gt;&gt; file1 = &#39;aqua/L2/2015/001/A2015001.L3m_DAY_CHL_chlor_a_1km.tif&#39;</span>
<span class="sd">        &gt;&gt;&gt; file2 = &#39;terra/L2/2015/001/T2015001.L3m_DAY_CHL_chlor_a_1km.tif&#39;</span>
<span class="sd">        &gt;&gt;&gt; file3 = &#39;viirs/L2/2015/001/V2015001.L3m_DAY_CHL_chlor_a_1km.tif&#39;</span>
<span class="sd">        &gt;&gt;&gt; compose_class = satmo.FileComposer(file1, file2, file3)</span>
<span class="sd">        &gt;&gt;&gt; compose_class.mean()</span>
<span class="sd">        &gt;&gt;&gt; compose_class.to_file(&#39;combined/X2015001.L3m_DAY_CHL_chlor_a_1km_2.tif&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_read_masked_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Util function to read a single layer raster file as masked np array</span>

<span class="sd">        The &#39;masked&#39; part has been removed when input is a geotiff (most</span>
<span class="sd">        likely produced by the binning function), rasterio reads cells flagged as</span>
<span class="sd">        nodata as np.nan in a geotiff by default.</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): Input file name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">filename_parser</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
            <span class="c1"># Read array</span>
            <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array</span>

    <span class="c1"># TODO: Test function below</span>
    <span class="k">def</span> <span class="nf">_read_compositing_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the COMPOSITING_META tag of the input files</span>

<span class="sd">        Because input of the compositing method may be composites too, the idea</span>
<span class="sd">        enable propagation of these compositing metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): Input file name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">composite_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="s1">&#39;COMPOSITING_META&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">composite_meta</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">composite_meta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate FileComposer class</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Filenames pointing to raster files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">get_raster_meta</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Get compositing metadata contained in input files, if there are none</span>
        <span class="c1"># it returns an empty dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositing_meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_compositing_meta</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span>\
                                 <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="k">if</span>\
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_read_compositing_meta</span><span class="p">(</span><span class="n">key</span><span class="p">)}</span>
        <span class="n">array_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_masked_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileComposer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">array_list</span><span class="p">)</span>

<div class="viewcode-block" id="FileComposer.to_file"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.FileComposer.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the composed array to file</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Name of file to which array has to be written</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># One of the method of the child class must have been ran before</span>
        <span class="c1"># running this method</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composed_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;dtype&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">update_tags</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="s1">&#39;COMPOSITING_META&#39;</span><span class="p">,</span>
                            <span class="n">compositing_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compositing_function</span><span class="p">,</span>
                            <span class="n">input_files</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">],</span>
                           <span class="n">input_meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compositing_meta</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="FileComposer.to_scidb"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.FileComposer.to_scidb">[docs]</a>    <span class="k">def</span> <span class="nf">to_scidb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="BasicBinMap"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap">[docs]</a><span class="k">class</span> <span class="nc">BasicBinMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class to produce daily gridded data for a given date/variable from L2 files</span>

<span class="sd">    The class is instantiated with a list of L2 files. The methods give the option to</span>
<span class="sd">    processed new variables from reflectance layers present in the L2 file, extract an existing</span>
<span class="sd">    one, mask the invalid observations and bin the resulting cleaned variable to a regular grid.</span>
<span class="sd">    All the methods of this class are exposed in the L3mProcess class so</span>
<span class="sd">    that there shouldn&#39;t be any need to use this class directly.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_list (list): List of L2 files (they should all belong to the same collection/day/etc)</span>
<span class="sd">        qual_array (str): Name of the quality array (named qual_prod in l2bin documentation)</span>
<span class="sd">            Used in a later filtering step by the apply_mask method. Mostly used for sst and nsst products.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        var (str): Optional name of variable to bin. Use when binning a variable that is already present in the archive</span>

<span class="sd">    Attributes:</span>
<span class="sd">        file_list (list): list of strings (the pathnames of individual L2 files)</span>
<span class="sd">        lon_dd (np.array): 1D Np array containing longitude coordinates</span>
<span class="sd">        lat_dd (np.array): 1D Np array containing latitude coordinates</span>
<span class="sd">        flag_array (np.array): 1D np array containing flag values</span>
<span class="sd">        qual_array (np.array): 1D np array containing pixel quality information (higher values</span>
<span class="sd">            mean lower quality)</span>
<span class="sd">        var_array (np.array): 1D np array containing variable to bin</span>
<span class="sd">        output_array (np.array): a 2D np array containing binned variable</span>
<span class="sd">        geo_dict (dict): A dictionary used to write the output_array using rasterio</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import satmo</span>

<span class="sd">        &gt;&gt;&gt; # Instantiate class using factory classmethod</span>
<span class="sd">        &gt;&gt;&gt; bin_class = satmo.BasicBinMap.from_sensor_date(&#39;A&#39;, date = &#39;2016-01-01&#39;, day = True, suite = &#39;OC&#39;,</span>
<span class="sd">                                                           data_root = &#39;/home/ldutrieux/sandbox/satmo2_data&#39;,</span>
<span class="sd">                                                           var = &#39;chlor_a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Apply mask with default parameters</span>
<span class="sd">        &gt;&gt;&gt; bin_class.apply_mask()</span>

<span class="sd">        &gt;&gt;&gt; # Bin the data to a 2 km resolution grid in a chosen resolution and extent</span>
<span class="sd">        &gt;&gt;&gt; bin_class.bin_to_grid(south = 3, north = 33, west = -122, east = -72,</span>
<span class="sd">                                  resolution = 2000, proj4string = &quot;+proj=laea +lat_0=20 +lon_0=-100&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Write grid with binned data to a georeferenced file</span>
<span class="sd">        &gt;&gt;&gt; bin_class.to_file(&#39;/home/ldutrieux/sandbox/satmo2_data/aqua/L3m/DAY/2016/001/A2016001.L3m_DAY_CHL_chlor_a_2km.tif&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_list</span><span class="p">,</span> <span class="n">qual_array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="n">file_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qual_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_array</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_array</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geo_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lon_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_dd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lon</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lat</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_band</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;l2_flags&#39;</span><span class="p">))</span>
            <span class="c1"># Read using the same logic the qual_array if its name is given</span>
            <span class="k">if</span> <span class="n">qual_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qual_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qual_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_band</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">qual_array</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag_array</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="n">var_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_band</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var_array</span> <span class="o">=</span> <span class="n">var_array</span>

<div class="viewcode-block" id="BasicBinMap.from_sensor_date"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap.from_sensor_date">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_sensor_date</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sensor_code</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">suite</span><span class="p">,</span> <span class="n">data_root</span><span class="p">,</span>
                         <span class="n">qual_array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative class buider that builds automatically the right file list</span>

<span class="sd">        Args:</span>
<span class="sd">            sensor_code (str): Sensor code (e.g. &#39;A&#39;, &#39;T&#39;, &#39;V&#39;) of the files to query.</span>
<span class="sd">            date (str or datetime): Date of the data to find</span>
<span class="sd">            day (bool): Are we looking for day data</span>
<span class="sd">            suite (str): L2 suite of input files (e.g. OC, SST, SST4, SST3)</span>
<span class="sd">            data_root (str): Root of the data archive</span>
<span class="sd">            qual_array (str): Name of the quality array (named qual_prod in l2bin documentation)</span>
<span class="sd">                Used in a later filtering step by the apply_mask method. Mostly used for sst and nsst products.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            var (str): Optional name of variable to bin. Use when binning a variable that is already present in the archive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="n">file_finder</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;L2&#39;</span><span class="p">,</span> <span class="n">suite</span> <span class="o">=</span> <span class="n">suite</span><span class="p">,</span> <span class="n">sensor_code</span> <span class="o">=</span> <span class="n">sensor_code</span><span class="p">)</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">file_list</span> <span class="k">if</span> <span class="n">is_day</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">day</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;No L2 files found&#39;</span><span class="p">)</span>
        <span class="n">bin_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">qual_array</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bin_class</span></div>

    <span class="k">def</span> <span class="nf">_read_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function to read a band as a numpy array</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): File name to read the variable from</span>
<span class="sd">            var (str): Name of the variable/band to read</span>

<span class="sd">        Returns:</span>
<span class="sd">            Numpy.array: Flattened numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;geophysical_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">def</span> <span class="nf">_read_band_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility to read a variable as a flattened numpy array from all files contained in self.file_list</span>

<span class="sd">        Args:</span>
<span class="sd">            var (str): Name of a variable present in all the netcdf files of</span>
<span class="sd">                self.file_list</span>

<span class="sd">        Return:</span>
<span class="sd">            np.array: A flattened numpy array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_band</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_get_lon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function to retrieve geolocation arrays from a L2 file</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): File name to read the variable from</span>

<span class="sd">        Return:</span>
<span class="sd">            np.array: flattened numpy arrays representing long</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;navigation_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lon</span>

    <span class="k">def</span> <span class="nf">_get_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Internal function to retrieve geolocation arrays from a L2 file</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): File name to read the variable from</span>

<span class="sd">        Return:</span>
<span class="sd">            np.array: flattened numpy arrays representing lat</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;navigation_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lat</span>

<div class="viewcode-block" id="BasicBinMap.set_variable"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap.set_variable">[docs]</a>    <span class="k">def</span> <span class="nf">set_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter for variable to bin</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.array): A flattened numpy array that should match with the self.lon_dd</span>
<span class="sd">                self.lat_dd, self.flags_array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dimension missmatch&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_array</span> <span class="o">=</span> <span class="n">x</span></div>

<div class="viewcode-block" id="BasicBinMap.apply_mask"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap.apply_mask">[docs]</a>    <span class="k">def</span> <span class="nf">apply_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bit_mask</span> <span class="o">=</span> <span class="mh">0x0669D73B</span><span class="p">,</span> <span class="n">max_qual</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to mask data using information from the flag array. And optionally the mask array (named qual_prod in l2bin documentation)</span>

<span class="sd">        Args:</span>
<span class="sd">            bit_mask (int): The mask to use for selecting active flags from the flag array</span>
<span class="sd">                The array is coded bitwise so that the mask has to be built as a bit mask too.</span>
<span class="sd">                It&#39;s generally more convenient to use hexadecimal to define the mask, for example</span>
<span class="sd">                if you want to activate flags 0, 3 and 5, you can pass 0x29 (0010 1001).</span>
<span class="sd">                The mask defaults to 0x0669D73B, which is the defaults value for seadas l2bin.</span>
<span class="sd">            max_qual (int): Maximum quality value of the qual array. Any value higher than</span>
<span class="sd">                this value will be used to filter out data. Defaults to 2.</span>
<span class="sd">                0, 1, 2 correspond to best, good, acceptable. Any value higher than that is bad</span>
<span class="sd">                Only applies if qual_array is not None during the class instantiation.</span>

<span class="sd">        Below the table of flag signification for modis, viirs and seawifs</span>

<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | Flag Name Modis/viirs   | Flag Name Seawifs   | Bit number   |</span>
<span class="sd">        +=========================+=====================+==============+</span>
<span class="sd">        | ATMFAIL                 | ATMFAIL             | 0            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | LAND                    | LAND                | 1            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | PRODWARN                | PRODWARN            | 2            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | HIGLINT                 | HIGLINT             | 3            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | HILT                    | HILT                | 4            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | HISATZEN                | HISATZEN            | 5            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | COASTZ                  | COASTZ              | 6            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SPARE                   | SPARE               | 7            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | STRAYLIGHT              | STRAYLIGHT          | 8            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | CLDICE                  | CLDICE              | 9            |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | COCCOLITH               | COCCOLITH           | 10           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | TURBIDW                 | TURBIDW             | 11           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | HISOLZEN                | HISOLZEN            | 12           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SPARE                   | SPARE               | 13           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | LOWLW                   | LOWLW               | 14           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | CHLFAIL                 | CHLFAIL             | 15           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | NAVWARN                 | NAVWARN             | 16           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | ABSAER                  | ABSAER              | 17           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SPARE                   | SPARE               | 18           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | MAXAERITER              | MAXAERITER          | 19           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | MODGLINT                | MODGLINT            | 20           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | CHLWARN                 | CHLWARN             | 21           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | ATMWARN                 | ATMWARN             | 22           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SPARE                   | SPARE               | 23           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SEAICE                  | SEAICE              | 24           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | NAVFAIL                 | NAVFAIL             | 25           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | FILTER                  | FILTER              | 26           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SPARE                   | SPARE               | 27           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | BOWTIEDEL               | SPARE               | 28           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | HIPOL                   | HIPOL               | 29           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | PRODFAIL                | PRODFAIL            | 30           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>
<span class="sd">        | SPARE                   | SPARE               | 31           |</span>
<span class="sd">        +-------------------------+---------------------+--------------+</span>

<span class="sd">        Default l2bin mask values for:</span>

<span class="sd">            +----------------------------------------------------+------------+</span>
<span class="sd">            | suite                                              | mask value |</span>
<span class="sd">            +====================================================+============+</span>
<span class="sd">            | General (includes Chlorophyl algorithms, Rrs, etc) | 0x669d73b  |</span>
<span class="sd">            +----------------------------------------------------+------------+</span>
<span class="sd">            | FLH                                                | 0x679d73f  |</span>
<span class="sd">            +----------------------------------------------------+------------+</span>
<span class="sd">            | PAR                                                | 0x600000a  |</span>
<span class="sd">            +----------------------------------------------------+------------+</span>
<span class="sd">            | SST                                                | 0x1002     |</span>
<span class="sd">            +----------------------------------------------------+------------+</span>
<span class="sd">            | NSST/SST4                                          | 0x2        |</span>
<span class="sd">            +----------------------------------------------------+------------+</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;A variable needs to be set or selected before masking&#39;</span><span class="p">)</span>
        <span class="c1"># Create mask</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bit_mask</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="c1"># if qual_array exists, create another mask and combine it with mask_array (&amp;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qual_array</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">qual_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qual_array</span> <span class="o">&lt;=</span> <span class="n">max_qual</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask_array</span> <span class="o">&amp;</span> <span class="n">qual_mask</span>
        <span class="c1"># Apply mask to various arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_array</span><span class="p">[</span><span class="n">mask_array</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon_dd</span><span class="p">[</span><span class="n">mask_array</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span><span class="p">[</span><span class="n">mask_array</span><span class="p">]</span></div>

<div class="viewcode-block" id="BasicBinMap.bin_to_grid"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap.bin_to_grid">[docs]</a>    <span class="k">def</span> <span class="nf">bin_to_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">proj4string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method for binning data to a defined grid</span>

<span class="sd">        A grid is defined by its extent (north, south, east, west), resolution, and</span>
<span class="sd">        projection (proj4string).</span>

<span class="sd">        Args:</span>
<span class="sd">            south (float): Southern border of output extent (in DD)</span>
<span class="sd">            north (float): Northern border of output extent (in DD)</span>
<span class="sd">            west (float): Western border of output extent (in DD)</span>
<span class="sd">            east (float): Eastern border of output extent (in DD)</span>
<span class="sd">            resolution (float): Output resolution (in the unit of the output coordinate reference system)</span>
<span class="sd">            proj4string (str): Coordinate reference system of the output in proj4 format</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Proj</span><span class="p">(</span><span class="n">proj4string</span><span class="p">)</span>

        <span class="c1"># Find output corner coordinates in bining grid CRS</span>
        <span class="c1"># Note that this does not account for the extent deformation induced by the projection</span>
        <span class="n">top_left</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">west</span><span class="p">,</span> <span class="n">north</span><span class="p">)</span>
        <span class="n">bottom_right</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">)</span>

        <span class="c1"># Define output array shape</span>
        <span class="n">destination_shape</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span><span class="n">top_left</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bottom_right</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">resolution</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span> <span class="nb">abs</span><span class="p">(</span><span class="n">top_left</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bottom_right</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span> <span class="p">)</span>
        <span class="c1"># Define affine transform and the inverse transform</span>
        <span class="n">aff</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">top_left</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">resolution</span><span class="p">,</span> <span class="n">top_left</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ffa</span> <span class="o">=</span> <span class="o">~</span><span class="n">aff</span>

        <span class="c1"># Convert the lat and lon arrays to projected coordinates</span>
        <span class="n">lon_proj</span><span class="p">,</span> <span class="n">lat_proj</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon_dd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_dd</span><span class="p">)</span>

        <span class="c1"># Convert projected coordinates to destination array indices</span>
        <span class="n">destination_ids</span> <span class="o">=</span> <span class="n">ffa</span> <span class="o">*</span> <span class="p">(</span><span class="n">lon_proj</span><span class="p">,</span> <span class="n">lat_proj</span><span class="p">)</span>

        <span class="c1"># Perform 2d data binning (to average all input coordinates falling withing the same outut pixel)</span>
        <span class="c1"># 1 Sum up within each bin</span>
        <span class="n">dst_array</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">destination_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">destination_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">destination_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">destination_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_array</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Retrieve count per bin</span>
        <span class="n">counts</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">destination_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">destination_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">destination_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">destination_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="c1"># Compute average value per bin</span>
        <span class="n">dst_array</span> <span class="o">=</span> <span class="n">dst_array</span> <span class="o">/</span> <span class="n">counts</span>
        <span class="c1"># Replace zeros by a more appropriate no data value (-1 since we are</span>
        <span class="c1"># writing to float and most values are between 0 and 1)</span>
        <span class="n">dst_array</span><span class="p">[</span><span class="n">dst_array</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">dst_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">dst_array</span><span class="p">)</span>
        <span class="c1"># Write array to slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_array</span> <span class="o">=</span> <span class="n">dst_array</span>
        <span class="c1"># Build geodict and write it to a slot of the object</span>
        <span class="n">geo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;crs&#39;</span><span class="p">:</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">proj4string</span><span class="p">),</span>
                    <span class="s1">&#39;affine&#39;</span><span class="p">:</span> <span class="n">aff</span><span class="p">,</span>
                    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">destination_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">destination_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;driver&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;compress&#39;</span><span class="p">:</span><span class="s1">&#39;lzw&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;nodata&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geo_dict</span> <span class="o">=</span> <span class="n">geo_dict</span></div>

<div class="viewcode-block" id="BasicBinMap.to_file"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a binned grid to a georeferenced tif file</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): Name of a tif file to write the frid to</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">geo_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The class does not contain the binned array </span><span class="se">\</span>
<span class="s1">                             and/or the geo_dict, You probably have to run the </span><span class="se">\</span>
<span class="s1">                             bin_to_grid method&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">geo_dict</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write_band</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span></div>

<div class="viewcode-block" id="BasicBinMap.to_scidb"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.BasicBinMap.to_scidb">[docs]</a>    <span class="k">def</span> <span class="nf">to_scidb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>



<div class="viewcode-block" id="L3mProcess"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.L3mProcess">[docs]</a><span class="k">class</span> <span class="nc">L3mProcess</span><span class="p">(</span><span class="n">BasicBinMap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to put the functions to compute</span>

<span class="sd">    inherits from BasicBinMap so that computing a new variable from reflectance bands is an optional step before</span>
<span class="sd">    binning</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; import satmo</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>

<span class="sd">        &gt;&gt;&gt; # Instantiate class using factory classmethod</span>
<span class="sd">        &gt;&gt;&gt; bin_class = satmo.L3mProcess.from_sensor_date(&#39;A&#39;, date = &#39;2016-01-01&#39;, day = True, suite = &#39;OC&#39;,</span>
<span class="sd">                                                           data_root = &#39;/home/ldutrieux/sandbox/satmo2_data&#39;)</span>

<span class="sd">        &gt;&gt;&gt; # Compute a new variable using the calc method</span>
<span class="sd">        &gt;&gt;&gt; def add_bands(x, y):</span>
<span class="sd">        &gt;&gt;&gt;     return np.add(x, y)</span>

<span class="sd">        &gt;&gt;&gt; bin_class.calc([&#39;Rrs_555&#39;, &#39;Rrs_645&#39;], add_bands)</span>

<span class="sd">        &gt;&gt;&gt; # Apply mask with default parameters</span>
<span class="sd">        &gt;&gt;&gt; bin_class.apply_mask()</span>

<span class="sd">        &gt;&gt;&gt; # Bin the data to a 2 km resolution grid in a chosen resolution and extent</span>
<span class="sd">        &gt;&gt;&gt; bin_class.bin_to_grid(south = 3, north = 33, west = -122, east = -72,</span>
<span class="sd">                                  resolution = 2000, proj4string = &quot;+proj=laea +lat_0=20 +lon_0=-100&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Write grid with binned data to a geo-referenced file</span>
<span class="sd">        &gt;&gt;&gt; bin_class.to_file(&#39;/home/ldutrieux/sandbox/satmo2_data/aqua/L3m/DAY/2016/001/A2016001.L3m_DAY_CHL_chlor_a_2km.tif&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_list</span><span class="p">,</span> <span class="n">qual_array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">L3mProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">qual_array</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

<div class="viewcode-block" id="L3mProcess.calc"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.L3mProcess.calc">[docs]</a>    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_list</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generic band math method</span>

<span class="sd">        Applies an arbitrary function to a set of arrays present in the netcdf</span>
<span class="sd">        file.</span>

<span class="sd">        Args:</span>
<span class="sd">            band_list (list): A list of bands/variables present in the file</span>
<span class="sd">                (e.g.: [&#39;Rrs_555&#39;, &#39;Rrs_645&#39;])</span>
<span class="sd">            fun (function): A function that takes len(band_list) arguments (all</span>
<span class="sd">                them must be numpy array of the same dimension) performs some</span>
<span class="sd">                element wise calculation on them and returns a single numpy array</span>
<span class="sd">                with the same dimension than each input array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read the bands from band_list with a list comprehension</span>
        <span class="n">array_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_band_all</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">band_list</span><span class="p">]</span>
        <span class="c1"># Pass the list of numpy arrays as *args to fun</span>
        <span class="n">out_array</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">array_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">out_array</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="l2bin"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.l2bin">[docs]</a><span class="k">def</span> <span class="nf">l2bin</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">L3b_suite</span><span class="p">,</span> <span class="n">var_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">night</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
          <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_root</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run l2bin for a list of L2 files</span>

<span class="sd">    This is a simple no filter python wrapper around the seadas l2bin utility.</span>

<span class="sd">    Args:</span>
<span class="sd">        file_list (list): list of L2 files (full paths)</span>
<span class="sd">        L3b_suite (str): Product suite to bin (see global variable STANDARD_L3_SUITES</span>
<span class="sd">            for corresponding variables)</span>
<span class="sd">        var_list (list): Optional list of variables to include in the produced L3b file.</span>
<span class="sd">            If None (default but not recommended), a list of standard variables is</span>
<span class="sd">            retrieved from the global variable (STANDARD_L3_SUITES)</span>
<span class="sd">        resolution (int or str): See resolve argument in l2bin doc</span>
<span class="sd">        night (bool): Is that night products</span>
<span class="sd">        filename (str): Optional full path of output filename (L3b). If not provided, a</span>
<span class="sd">            filename is automatically generated.</span>
<span class="sd">        data_root (str): Root of the data archive. Mandatory if filename is not provided</span>
<span class="sd">            ignored otherwise</span>
<span class="sd">        overwrite (bool): Overwrite file if already exists? Defaults to False</span>
<span class="sd">        flags (list): A list of flags to mask invalid data (e.g. [&#39;CLDICE&#39;, &#39;LAND&#39;, &#39;HIGLINT&#39;])</span>
<span class="sd">            If None (default), a default list of flag for the L3 suite is fetched from</span>
<span class="sd">            the global variable FLAGS</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The output filename</span>

<span class="sd">    Raises:</span>
<span class="sd">        satmo.SeadasError: if the seadas command exists with status 1</span>

<span class="sd">    Example usage:</span>
<span class="sd">        &gt;&gt;&gt; import satmo, glob</span>

<span class="sd">        &gt;&gt;&gt; infiles = glob.glob(&#39;/home/ldutrieux/sandbox/satmo2_data/aqua/L2/2016/001/*L2*nc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; satmo.OC_l2bin(infiles, &#39;CHL&#39;, data_root = &#39;/home/ldutrieux/sandbox/satmo2_data&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_meta</span> <span class="o">=</span> <span class="n">filename_parser</span><span class="p">(</span><span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Generate filename if it hasn&#39;t been provided</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data_root argument must be provided if filename is left empty (None)&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_builder</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;L3b&#39;</span><span class="p">,</span> <span class="n">full_path</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                       <span class="n">data_root</span> <span class="o">=</span> <span class="n">data_root</span><span class="p">,</span> <span class="n">suite</span> <span class="o">=</span> <span class="n">L3b_suite</span><span class="p">,</span>
                                       <span class="n">filename</span> <span class="o">=</span> <span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">composite</span><span class="o">=</span><span class="s1">&#39;DAY&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">FLAGS</span><span class="p">[</span><span class="n">L3b_suite</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">L3b_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Create directory if not already exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">L3b_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">L3b_dir</span><span class="p">)</span>
        <span class="c1"># Create text file with input L2 files</span>
        <span class="n">file_list_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">L3b_dir</span><span class="p">,</span> <span class="s1">&#39;L2_file_list_</span><span class="si">%d%03d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                     <span class="p">(</span><span class="n">input_meta</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">input_meta</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">],</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9999</span><span class="p">)))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_list_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Get the standards products from the global variable</span>
        <span class="k">if</span> <span class="n">var_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_list</span> <span class="o">=</span> <span class="n">STANDARD_L3_SUITES</span><span class="p">[</span><span class="n">L3b_suite</span><span class="p">][</span><span class="n">input_meta</span><span class="p">[</span><span class="s1">&#39;sensor&#39;</span><span class="p">]]</span>
        <span class="c1"># BUild l3b command</span>
        <span class="n">l2bin_arg_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l2bin&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;l3bprod=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_list</span><span class="p">),</span>
                          <span class="s1">&#39;infile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">file_list_file</span><span class="p">,</span>
                          <span class="s1">&#39;resolve=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolution</span><span class="p">),</span>
                          <span class="s1">&#39;ofile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                          <span class="s1">&#39;flaguse=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">),</span>
                          <span class="s1">&#39;night=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">night</span><span class="p">),</span>
                          <span class="s1">&#39;prodtype=regional&#39;</span><span class="p">]</span>
        <span class="n">qual_array</span> <span class="o">=</span> <span class="n">QUAL_ARRAY_NAME_FROM_SUITE</span><span class="p">[</span><span class="n">L3b_suite</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">qual_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">l2bin_arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;qual_prod=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">qual_array</span><span class="p">)</span>
        <span class="c1"># Execute command</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">FNULL</span><span class="p">:</span>
            <span class="c1"># Run cli</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">l2bin_arg_list</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">FNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SeadasError</span><span class="p">(</span><span class="s1">&#39;l2bin exited with status 1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="l3mapgen"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.l3mapgen">[docs]</a><span class="k">def</span> <span class="nf">l3mapgen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">resolution</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">proj</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">data_root</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">composite</span> <span class="o">=</span> <span class="s1">&#39;DAY&#39;</span><span class="p">,</span>
             <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run l3mapgen from a l3b file</span>

<span class="sd">    Args:</span>
<span class="sd">        x (str): Path to input L3b file</span>
<span class="sd">        variable (str): variable to warp (should exist in the L3b file) (e.g.: sst, chlor_a, Rrs_555, ...)</span>
<span class="sd">        south (int or float): south latitude of mapped file extent</span>
<span class="sd">        north (int or float): north latitude of mapped file extent</span>
<span class="sd">        west (int or float): west longitude of mapped file extent</span>
<span class="sd">        east (int or float): east longitude of mapped file extent</span>
<span class="sd">        filename (str): Optional full path of output filename (L3m). If not provided, a</span>
<span class="sd">            filename is automatically generated.</span>
<span class="sd">        resolution (int): MApping resolution in meters. Defaults to 1000</span>
<span class="sd">        proj (str): Optional proj4 string. If None (default), a lambert Azimutal Equal Area projection (laea), centered</span>
<span class="sd">            on the provided extent is used.</span>
<span class="sd">        data_root (str): Root of the data archive. Mandatory if filename is not provided</span>
<span class="sd">            ignored otherwise</span>
<span class="sd">        composite (str): Compositing period (DAY, 8DAY, MON). Used for building output filename</span>
<span class="sd">            Defaults to DAY</span>
<span class="sd">        overwrite (bool): Overwrite file if already exists? Defaults to False</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The output filename</span>

<span class="sd">    Raises:</span>
<span class="sd">        satmo.SeadasError: if the seadas command exists with status 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># l3mapgen ifile=T2016292.L3b_DAY_OC ofile=T2016292.L3B_DAY_RRS_laea.tif resolution=1km south=26 north=40 west=-155 east=-140 projection=&quot;+proj=laea +lat_0=33 +lon_0=-147&quot;</span>
    <span class="n">input_meta</span> <span class="o">=</span> <span class="n">filename_parser</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">m&#39;</span> <span class="o">%</span> <span class="n">resolution</span>
    <span class="c1"># build file if it doesn&#39;t yet exist</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data_root argument must be provided if filename is left empty (None)&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_builder</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;L3m&#39;</span><span class="p">,</span> <span class="n">full_path</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">data_root</span> <span class="o">=</span> <span class="n">data_root</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">composite</span> <span class="o">=</span> <span class="n">composite</span><span class="p">,</span>
                                    <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="n">to_km</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="c1"># Handle projection options</span>
        <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="s1">&#39;smi&#39;</span>
        <span class="c1"># Create directory if not already exists</span>
        <span class="n">L3m_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">L3m_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">L3m_dir</span><span class="p">)</span>
        <span class="c1"># filename, composite, variable, resolution, (nc)</span>
        <span class="n">l3map_arg_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l3mapgen&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;ifile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span>
                          <span class="s1">&#39;ofile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                          <span class="s1">&#39;resolution=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resolution</span><span class="p">,</span>
                          <span class="s1">&#39;south=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">south</span><span class="p">,</span>
                          <span class="s1">&#39;north=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">north</span><span class="p">,</span>
                          <span class="s1">&#39;west=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">west</span><span class="p">,</span>
                          <span class="s1">&#39;east=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">east</span><span class="p">,</span>
                          <span class="s1">&#39;product=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">variable</span><span class="p">,</span>
                          <span class="s1">&#39;interp=area&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;apply_pal=0&#39;</span><span class="p">,</span> <span class="c1"># Otherwise color map is applied which implies generating a byte image only</span>
                          <span class="s1">&#39;oformat=tiff&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;projection=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">proj</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">FNULL</span><span class="p">:</span>
            <span class="c1"># Run cli</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">l3map_arg_list</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">FNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SeadasError</span><span class="p">(</span><span class="s1">&#39;l3mapgen exited with status 1 for input file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># Update dataset nodata value using rasterio</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">src</span><span class="o">.</span><span class="n">nodata</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32767</span>
    <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="make_time_composite"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.make_time_composite">[docs]</a><span class="k">def</span> <span class="nf">make_time_composite</span><span class="p">(</span><span class="n">date_list</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">suite</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">composite</span><span class="p">,</span>
                        <span class="n">data_root</span><span class="p">,</span> <span class="n">sensor_code</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preview</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a time composite (L3m) from daily L3m data</span>

<span class="sd">    Args:</span>
<span class="sd">        date_list (list): A list of the dates to include in the composite</span>
<span class="sd">        var (str): L3m variable to composite</span>
<span class="sd">        suite (str): L3m suite</span>
<span class="sd">        resolution (str): Resolution of data to compose (e.g.: &#39;2km&#39;)</span>
<span class="sd">        composite (str): Type/name of generated composite (e.g.: &#39;8DAY&#39;, &#39;16DAY&#39;). Used</span>
<span class="sd">            for automatic output filename generation.</span>
<span class="sd">        data_root (str): Root of the data archive</span>
<span class="sd">        sensor_code (str): Sensor to composite (defaults to &#39;X&#39;, which</span>
<span class="sd">            corresponds to daily (cross sensors) composites.</span>
<span class="sd">        fun (str): compositing function, defaults to mean</span>
<span class="sd">        filename (str): Optional output filename. Auto generated if not provided</span>
<span class="sd">        overwrite (bool): Should output file be overwritten if it already</span>
<span class="sd">            exists.</span>
<span class="sd">        preview (bool): Should a png preview be automatically generated</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The filename of the produced file.</span>
<span class="sd">        In case no file is produced (because no input files were found, the function exits without return value.</span>
<span class="sd">        When automatically generated the date of the composite corresponds to the first day of the composite.</span>

<span class="sd">    Example usage:</span>
<span class="sd">        &gt;&gt;&gt; import datetime</span>
<span class="sd">        &gt;&gt;&gt; import satmo</span>

<span class="sd">        &gt;&gt;&gt; begin = datetime.datetime(2016, 01, 01)</span>
<span class="sd">        &gt;&gt;&gt; date_list = [begin + datetime.timedelta(days=x) for x in range(0, 16)]</span>
<span class="sd">        &gt;&gt;&gt; satmo.make_time_composite(date_list, &#39;chlor_a&#39;, &#39;CHL&#39;, &#39;2km&#39;,</span>
<span class="sd">                                      &#39;16DAY&#39;,</span>
<span class="sd">                                      &#39;/home/ldutrieux/sandbox/satmo2_data&#39;,</span>
<span class="sd">                                      overwrite=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Search for the list of files</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
        <span class="n">file_query</span> <span class="o">=</span> <span class="n">file_finder</span><span class="p">(</span><span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;L3m&#39;</span><span class="p">,</span> <span class="n">suite</span><span class="o">=</span><span class="n">suite</span><span class="p">,</span>
                                    <span class="n">sensor_code</span><span class="o">=</span><span class="n">sensor_code</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                                    <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">composite</span><span class="o">=</span><span class="s1">&#39;DAY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_query</span><span class="p">:</span>
            <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_query</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Exit if list of files is empty</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># COmpose files</span>
    <span class="n">compose_class</span> <span class="o">=</span> <span class="n">FileComposer</span><span class="p">(</span><span class="o">*</span><span class="n">file_list</span><span class="p">)</span>
    <span class="c1"># Run the compositing method using string provided in fun= argument</span>
    <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">compose_class</span><span class="p">,</span> <span class="n">fun</span><span class="p">)</span>
    <span class="n">func</span><span class="p">()</span>
    <span class="c1"># Generate filename if not provided</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_builder</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;L3m&#39;</span><span class="p">,</span> <span class="n">full_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">date_list</span><span class="p">),</span>
                                       <span class="n">sensor_code</span><span class="o">=</span><span class="n">sensor_code</span><span class="p">,</span>
                                       <span class="n">suite</span><span class="o">=</span><span class="n">suite</span><span class="p">,</span>
                                       <span class="n">composite</span><span class="o">=</span><span class="n">composite</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                       <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">)</span>
    <span class="c1"># Write to file (if overwrite conditions are met)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="c1"># Create directory if not already exists</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
        <span class="n">compose_class</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">preview</span><span class="p">:</span>
            <span class="n">make_preview</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>



<div class="viewcode-block" id="l2_append"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.l2_append">[docs]</a><span class="k">def</span> <span class="nf">l2_append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">short_name</span><span class="p">,</span> <span class="n">long_name</span><span class="p">,</span> <span class="n">standard_name</span><span class="p">,</span>
              <span class="n">valid_min</span><span class="p">,</span> <span class="n">valid_max</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute a new array and append it to an existing OBPG L2 file</span>

<span class="sd">    This function can be called by passing a nested dict of the global variable</span>
<span class="sd">    BAND_MATH_FUNCTIONS as kwargs. Example l2_append(x, **BAND_MATH_FUNCTIONS[&#39;afai&#39;][sensor])</span>

<span class="sd">    Args:</span>
<span class="sd">        x (str): Input L2 file in netCDF format</span>
<span class="sd">        bands (list): List of strings corresponding to the names of the</span>
<span class="sd">            netCDF dataset variables used to compute the new array. They must</span>
<span class="sd">            be provided in the same order than used in the formula argument</span>
<span class="sd">        formula (func): The function used to compute the new variable. Each argument</span>
<span class="sd">            must be an array, and len(args) must equal len(input_bands)</span>
<span class="sd">        short_name (str): Short name for the newly create dataset (used as netCDF</span>
<span class="sd">            variable name)</span>
<span class="sd">        long_name (str): Name of the newly create dataset</span>
<span class="sd">        standard_name (str): Name of the newly create dataset</span>
<span class="sd">        valid_min (float): Valid minimum value</span>
<span class="sd">        valid_max (float): Valid maximum value</span>

<span class="sd">    Returns:</span>
<span class="sd">        The function is used for its side effect of appending a new variable to an existing netCDF file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">nc</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;geophysical_data&#39;</span><span class="p">]</span>
        <span class="n">newVar</span> <span class="o">=</span> <span class="n">geo</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="n">short_name</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;number_of_lines&#39;</span><span class="p">,</span> <span class="s1">&#39;pixels_per_line&#39;</span><span class="p">),</span>
                                    <span class="n">fill_value</span><span class="o">=</span><span class="n">geo</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">_FillValue</span><span class="p">)</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="n">long_name</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="n">standard_name</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">valid_min</span> <span class="o">=</span> <span class="n">valid_min</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">valid_max</span> <span class="o">=</span> <span class="n">valid_max</span>
        <span class="n">newVar</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">geo</span><span class="p">[</span><span class="n">x</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">])</span></div>


<div class="viewcode-block" id="l2mapgen"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.l2mapgen">[docs]</a><span class="k">def</span> <span class="nf">l2mapgen</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">prod</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">data_root</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">width</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper for l2mapgen seadas command line utility</span>

<span class="sd">    Args:</span>
<span class="sd">        x (str): Input file name</span>
<span class="sd">        south (float): Southern border of output extent (in DD)</span>
<span class="sd">        north (float): Northern border of output extent (in DD)</span>
<span class="sd">        west (float): Western border of output extent (in DD)</span>
<span class="sd">        east (float): Eastern border of output extent (in DD)</span>
<span class="sd">        prod (str): Product to map (e.g.: &#39;chlor_a&#39;)</span>
<span class="sd">        flags (list): List of flags to apply (see global variable FLAGS)</span>
<span class="sd">        data_root (str): Root of the data archive</span>
<span class="sd">        width (int): Width in pixels of the output image</span>
<span class="sd">        outmode (str): See seadas l2mapgen doc</span>
<span class="sd">        threshold (float): Minimum percentage of the filled pixels</span>
<span class="sd">        overwrite (bool): Overwrite existing files? Return ValueError if file exists</span>
<span class="sd">            and overwrite is set to False (default)</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import satmo</span>
<span class="sd">        &gt;&gt;&gt; from satmo.global_variables import FLAGS, L3_SUITE_FROM_VAR</span>

<span class="sd">        &gt;&gt;&gt; x = &#39;/media/ldutrieux/LoicCONAext/satmo/aqua/L2/2015/077/A2015077191500.L2_LAC_AFAI.nc&#39;</span>
<span class="sd">        &gt;&gt;&gt; data_root = &#39;/media/ldutrieux/LoicCONAext/satmo/&#39;</span>

<span class="sd">        &gt;&gt;&gt; satmo.l2mapgen(x=x, data_root=data_root, south=3, north=33, west=-122, east=-72,</span>
<span class="sd">                           prod=&#39;afai&#39;, flags = FLAGS[&#39;AFAI&#39;])</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The output filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate automatic filename if not provided</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_day</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="s1">&#39;day&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="s1">&#39;night&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_builder</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;L2m&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">suite</span><span class="o">=</span><span class="n">L3_SUITE_FROM_VAR</span><span class="p">[</span><span class="n">dn</span><span class="p">][</span><span class="n">prod</span><span class="p">],</span>
                                       <span class="n">variable</span><span class="o">=</span><span class="n">prod</span><span class="p">,</span> <span class="n">full_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error while running l2mapgen on </span><span class="si">%s</span><span class="s1">; file exists and overwrite set to False&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Create output dir in case it does not exist</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>

    <span class="c1"># Prepare inputs</span>
    <span class="n">cli_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l2mapgen&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ifile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span>
                <span class="s1">&#39;ofile=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                <span class="s1">&#39;prod=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">prod</span><span class="p">,</span>
                <span class="s1">&#39;flaguse=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">),</span>
                <span class="s1">&#39;south=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">south</span><span class="p">,</span>
                <span class="s1">&#39;north=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">north</span><span class="p">,</span>
                <span class="s1">&#39;west=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">west</span><span class="p">,</span>
                <span class="s1">&#39;east=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">east</span><span class="p">,</span>
                <span class="s1">&#39;mask=true&#39;</span><span class="p">,</span>
                <span class="s1">&#39;width=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">width</span><span class="p">,</span>
                <span class="s1">&#39;apply_pal=0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;threshold=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">threshold</span><span class="p">,</span>
                <span class="s1">&#39;outmode=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">]</span>

    <span class="c1"># l2mapgen is very verbose, therefore redirect output to devnull</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">FNULL</span><span class="p">:</span>
        <span class="c1"># Run cli</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cli_args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">FNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="c1"># l2mapgen ifile=A2015077191500.L2_LAC_AFAI.nc ofile=A2015077191500.L2m_afai.tif prod=afai south=3 north=33 west=-122 east=-72 flaguse=LAND,HIGLINT,CLDICE mask=true width=5000 outmode=tiff</span>

    <span class="c1"># Check status (return error in case )</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SeadasError</span><span class="p">(</span><span class="s1">&#39;l2mapgen exited with status </span><span class="si">%d</span><span class="s1"> during L2 mapping&#39;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

    <span class="c1"># Update dataset nodata value using rasterio</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">src</span><span class="o">.</span><span class="n">nodata</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32767</span>

    <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="l3bin"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.l3bin">[docs]</a><span class="k">def</span> <span class="nf">l3bin</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple wrapper for seadas l3bin</span>

<span class="sd">    Used for temporal compositing</span>

<span class="sd">    Args:</span>
<span class="sd">        file_list (list): List of input L3b files</span>
<span class="sd">        south (float): Southern border of output extent (in DD)</span>
<span class="sd">        north (float): Northern border of output extent (in DD)</span>
<span class="sd">        west (float): Western border of output extent (in DD)</span>
<span class="sd">        east (float): Eastern border of output extent (in DD)</span>
<span class="sd">        filename (str): Optional output filename</span>
<span class="sd">        overwrite (bool): Overwrite existing files?</span>

<span class="sd">    Return:</span>
<span class="sd">        str: The output filename. Mostly used for its side effects of generating</span>
<span class="sd">            a L3b temporal composite file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_meta</span> <span class="o">=</span> <span class="n">filename_parser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">L3b_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Create directory if not already exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">L3b_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">L3b_dir</span><span class="p">)</span>
        <span class="c1"># Create text file with input L2 files</span>
        <span class="n">file_list_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">L3b_dir</span><span class="p">,</span> <span class="s1">&#39;L3b_file_list_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d%03d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                     <span class="p">(</span><span class="n">output_meta</span><span class="p">[</span><span class="s1">&#39;composite&#39;</span><span class="p">],</span> <span class="n">output_meta</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span>
                                      <span class="n">output_meta</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">],</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9999</span><span class="p">)))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_list_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
                <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">cli_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l3bin&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;in=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">file_list_file</span><span class="p">,</span>
                    <span class="s1">&#39;loneast=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">east</span><span class="p">,</span>
                    <span class="s1">&#39;lonwest=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">west</span><span class="p">,</span>
                    <span class="s1">&#39;latnorth=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">north</span><span class="p">,</span>
                    <span class="s1">&#39;latsouth=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">south</span><span class="p">,</span>
                    <span class="s1">&#39;out=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">FNULL</span><span class="p">:</span>
            <span class="c1"># Run cli</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cli_args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">FNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SeadasError</span><span class="p">(</span><span class="s1">&#39;l3bin exited with status </span><span class="si">%d</span><span class="s1"> during temporal binning&#39;</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File exists, set overwrite to True for overwriting file&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="l3bin_wrapper"><a class="viewcode-back" href="../../api/satmo.processors.html#satmo.processors.l3bin_wrapper">[docs]</a><span class="k">def</span> <span class="nf">l3bin_wrapper</span><span class="p">(</span><span class="n">sensor_codes</span><span class="p">,</span> <span class="n">date_list</span><span class="p">,</span> <span class="n">suite_list</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">composite</span><span class="p">,</span>
                  <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapper to run l3bin without having to name explicitly input or output files</span>

<span class="sd">    Args:</span>
<span class="sd">        sensor_codes (list): List of sensor codes to include (e.g.: [&#39;A&#39;, &#39;T&#39;, &#39;V&#39;]</span>
<span class="sd">        date_list (list): List of dates</span>
<span class="sd">        suite_list (list): List of L3 suites to include</span>
<span class="sd">        south (float): Southern border of output extent (in DD)</span>
<span class="sd">        north (float): Northern border of output extent (in DD)</span>
<span class="sd">        west (float): Western border of output extent (in DD)</span>
<span class="sd">        east (float): Eastern border of output extent (in DD)</span>
<span class="sd">        composite (str): Composite type (8DAY, MON)</span>
<span class="sd">        overwrite (bool): Overwrite existing files?</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of L3b files generated. Mostly used for its side effect of generating</span>
<span class="sd">        temporally composited L3b files from daily L3b files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sensor_code</span> <span class="ow">in</span> <span class="n">sensor_codes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">suite</span> <span class="ow">in</span> <span class="n">suite_list</span><span class="p">:</span>
            <span class="n">file_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">:</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">file_finder</span><span class="p">(</span><span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;L3b&#39;</span><span class="p">,</span>
                                   <span class="n">suite</span><span class="o">=</span><span class="n">suite</span><span class="p">,</span> <span class="n">sensor_code</span><span class="o">=</span><span class="n">sensor_code</span><span class="p">,</span>
                                   <span class="n">composite</span><span class="o">=</span><span class="n">composite</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">file_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_builder</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;L3b&#39;</span><span class="p">,</span> <span class="n">full_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">date_list</span><span class="p">),</span>
                                           <span class="n">sensor_code</span><span class="o">=</span><span class="n">sensor_code</span><span class="p">,</span> <span class="n">suite</span><span class="o">=</span><span class="n">suite</span><span class="p">,</span>
                                           <span class="n">composite</span><span class="o">=</span><span class="n">composite</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">l3bin</span><span class="p">(</span><span class="n">file_list</span><span class="o">=</span><span class="n">file_list</span><span class="p">,</span> <span class="n">north</span><span class="o">=</span><span class="n">north</span><span class="p">,</span> <span class="n">south</span><span class="o">=</span><span class="n">south</span><span class="p">,</span> <span class="n">west</span><span class="o">=</span><span class="n">west</span><span class="p">,</span>
                                 <span class="n">east</span><span class="o">=</span><span class="n">east</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">pprint</span><span class="p">(</span><span class="s1">&#39;l3bin: </span><span class="si">%s</span><span class="s1"> could not be produced. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out_list</span></div>


</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, CONABIO.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.2.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>